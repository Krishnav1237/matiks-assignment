<%
  const buildParams = (extra) => {
    const params = new URLSearchParams();
    const all = { ...filters, ...extra };
    for (const [k, v] of Object.entries(all)) {
      if (v !== undefined && v !== null && v !== '' && v !== 'undefined') params.append(k, v);
    }
    return params.toString();
  };
%>
<%- include('layout', { body: `

<!-- Strict Box Aligned Header -->
<div class="page-header" style="height: 80px; background: white; border-bottom: 1px solid #E5E7EB; padding: 0 32px; display: flex; align-items: center;">
  <div style="flex: 1;">
    <h1 class="page-header-title" style="font-size: 1.5rem; font-weight: 700; color: #111827; letter-spacing: -0.01em;">App Reviews</h1>
  </div>
</div>

<!-- Tier 2: Sticky Filter Toolbar (Professional Spacing) -->
<div style="position: sticky; top: 0; z-index: 20; background: #F9FAFB; padding: 24px 32px; border-bottom: 1px solid #E5E7EB; display: flex; justify-content: space-between; align-items: center;">
  
  <!-- Left: Filters -->
  <div style="display: flex; gap: 16px; align-items: center; flex: 1;">
    <form id="reviewsFilterForm" method="GET" style="display: flex; gap: 16px; align-items: center; width: 100%;">
      
      <!-- Store Select -->
      <select name="platform" onchange="this.form.submit()" style="height: 40px; padding: 0 36px 0 16px; border-radius: 8px; border: 1px solid #D1D5DB; background: white; color: #374151; font-size: 0.875rem; cursor: pointer; min-width: 140px;">
        <option value="">All Stores</option>
        <option value="playstore" ${filters.platform === 'playstore' ? 'selected' : ''}>Play Store</option>
        <option value="appstore" ${filters.platform === 'appstore' ? 'selected' : ''}>App Store</option>
      </select>
      
      <!-- Rating Select -->
      <select name="rating" onchange="this.form.submit()" style="height: 40px; padding: 0 36px 0 16px; border-radius: 8px; border: 1px solid #D1D5DB; background: white; color: #374151; font-size: 0.875rem; cursor: pointer; min-width: 140px;">
        <option value="">All Ratings</option>
        <option value="5" ${filters.rating === 5 ? 'selected' : ''}>‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ (5)</option>
        <option value="4" ${filters.rating === 4 ? 'selected' : ''}>‚òÖ‚òÖ‚òÖ‚òÖ (4)</option>
        <option value="3" ${filters.rating === 3 ? 'selected' : ''}>‚òÖ‚òÖ‚òÖ (3)</option>
        <option value="2" ${filters.rating === 2 ? 'selected' : ''}>‚òÖ‚òÖ (2)</option>
        <option value="1" ${filters.rating === 1 ? 'selected' : ''}>‚òÖ (1)</option>
      </select>
      
      <!-- Search Input -->
      <div style="position: relative; flex: 1; max-width: 320px;">
        <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #9CA3AF;">üîç</span>
        <input type="text" name="search" value="${filters.search || ''}" placeholder="Search reviews..." style="width: 100%; height: 40px; padding: 0 16px 0 36px; border-radius: 8px; border: 1px solid #D1D5DB; background: white; color: #374151; font-size: 0.875rem;">
      </div>

      <!-- Hidden submit -->
      <input type="submit" style="display: none;">
    </form>
  </div>

  <!-- Right: Actions -->
  <div style="display: flex; gap: 16px; align-items: center; padding-left: 24px;">
    <div style="color: #6B7280; font-size: 0.875rem; font-weight: 500;">
      Showing <strong style="color: #111827;">${reviews.length}</strong> results
    </div>
    <a href="/api/export/reviews" style="height: 40px; padding: 0 20px; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; border-radius: 8px; background: #2563EB; color: white; text-decoration: none; font-size: 0.875rem; transition: background 0.2s;">
      <span>‚¨á</span> Export CSV
    </a>
  </div>

</div>

<!-- Full Width Reviews Table -->
  ${reviews.length === 0 ? `
    <div class="empty-state card" style="margin: var(--space-6);">
      <div style="font-size: 48px; margin-bottom: 16px;">‚≠ê</div>
      <h3 class="text-lg font-medium text-primary">No reviews found</h3>
      <p class="text-subtle">Try adjusting your filters.</p>
    </div>
  ` : `
    <div class="table-container" style="border-top: 1px solid var(--border); background: white;">
      <table class="data-table">
        <thead>
          <tr>
            <th style="width: 120px; padding-left: var(--space-6);">Date</th>
            <th style="width: 100px;">Store</th>
            <th style="width: 120px;">Rating</th>
            <th>Feedback</th>
            <th style="width: 120px;">Sentiment</th>
          </tr>
        </thead>
        <tbody>
          ${reviews.map(r => `
            <tr>
              <td class="text-subtle" style="white-space: nowrap; vertical-align: top; padding-left: var(--space-6);">${new Date(r.review_date).toLocaleDateString()}</td>
              <td style="vertical-align: top;"><span class="badge badge-neu">${r.platform_name}</span></td>
              <td style="vertical-align: top;">
                <div class="text-sm font-bold text-primary">
                  ${'‚òÖ'.repeat(r.rating)}<span class="text-subtle">${'‚òÜ'.repeat(5 - r.rating)}</span>
                </div>
              </td>
              <td style="vertical-align: top;">
                <div class="mb-1 font-medium text-primary">${r.title || ''}</div>
                <div class="text-sm text-primary" style="line-height: 1.5; margin-bottom: 4px;">
                  ${(r.content || '').length > 250 
                    ? (r.content || '').substring(0, 250).replace(/"/g, '&quot;') + '...' 
                    : (r.content || '').replace(/"/g, '&quot;')}
                </div>
                ${r.app_version ? `<div class="mt-1 text-xs text-subtle">v${r.app_version} by ${r.author}</div>` : `<div class="mt-1 text-xs text-subtle">by ${r.author}</div>`}
              </td>
              <td style="vertical-align: top;">
                <span class="badge badge-${r.sentiment_label === 'positive' ? 'pos' : r.sentiment_label === 'negative' ? 'neg' : 'neu'}">
                  ${r.sentiment_label || 'neu'}
                </span>
              </td>
            </tr>
            ${r.developer_reply ? `
            <tr style="background-color: var(--background-subtle);">
              <td colspan="5" style="padding: 12px 24px;">
                <div class="flex gap-2">
                  <span class="text-xs font-bold text-primary uppercase">Developer Reply:</span>
                  <span class="text-xs text-secondary">${r.developer_reply}</span>
                </div>
              </td>
            </tr>
            ` : ''}
          `).join('')}
        </tbody>
      </table>
    </div>

    <!-- Centered Professional Pagination -->
    <div style="display: flex; justify-content: center; align-items: center; margin-top: 0; padding: 32px; border-top: 1px solid #E5E7EB; background: white; gap: 16px;">
       ${filters.offset > 0 ? `<a href="?${buildParams({ offset: Math.max(0, (filters.offset || 0) - 50) })}" class="btn btn-secondary" style="height: 40px; padding: 0 24px; font-weight: 500;">Previous</a>` : ''}
       
       <div style="color: #6B7280; font-size: 0.875rem; font-variant-numeric: tabular-nums;">
         Page <span style="color: #111827; font-weight: 600;">${Math.floor((filters.offset || 0) / 50) + 1}</span>
       </div>

       ${reviews.length >= 50 ? `<a href="?${buildParams({ offset: (filters.offset || 0) + 50 })}" class="btn btn-secondary" style="height: 40px; padding: 0 24px; font-weight: 500;">Next</a>` : ''}
    </div>
  `}
` }) %>
